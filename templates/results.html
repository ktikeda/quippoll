{% extends 'base.html' %}

{% block title %}{{ poll.title }}{% endblock %}

{% block content %}

<h1>{{ poll.prompt }}</h1>

    {% for response in poll.responses %}
        <span id="response-{{ response.response_id }}">{{ response.text }}</span>{% if poll.poll_type.collect_tally %}: <span id="response-{{ response.response_id }}-val">{{ response.value() }}</span>{% endif %}<br>

    {% endfor %}
<script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
<script type="text/javascript" charset="utf-8">
  $(document).ready( function() {

    namespace = '/poll';

    // Connect to the Socket.IO server.
    // The connection URL has the following format:
    //     http[s]://<domain>:<port>[/<namespace>]
    let socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);

    // Event handler for new connections.
    // The callback function is invoked when a connection with the
    // server is established.
    socket.on('connect', function() {
        socket.emit('client_connect', {data: 'Client connected!'});
    });

    // Event handler for server sent data.
    // The callback function is invoked whenever the server emits data
    // to the client.
    socket.on('new_tally', function(data) {
        console.log(data);
        let tag = "#response-" + String(data.response_id) + "-val";

        console.log(tag);

        let currentVal = parseInt($(tag).html());

        let newVal = currentVal + data.val;

        $(tag).html(String(newVal));

    });

  });
</script>

{% endblock %}